{% extends 'base.html' %}
{% block title %}PDF í•©ì¹˜ê¸°{% endblock %}

{% block content %}
<h2>ğŸ“ PDF í•©ì¹˜ê¸°</h2>
<p>íŒŒì¼ì„ ì¶”ê°€í•˜ê³  ìˆœì„œë¥¼ ë“œë˜ê·¸ë¡œ ì¡°ì •í•´ë³´ì„¸ìš”!</p>

<form id="pdf-form" action="/pdf" method="POST" enctype="multipart/form-data">
  <input type="file" id="pdf-input" multiple accept=".pdf" hidden>
  <button type="button" class="btn btn-secondary" onclick="document.getElementById('pdf-input').click()">ğŸ“‚ íŒŒì¼ ì„ íƒ</button>

  <ul id="file-list" class="list-group my-3"></ul>
  <div class="mb-3">
    <label for="filename" class="form-label">ì €ì¥í•  íŒŒì¼ëª… (í™•ì¥ì .pdf ì œì™¸)</label>
    <input type="text" class="form-control" id="filename" name="filename" placeholder="ì˜ˆ: my_merged_file" required>
  </div>
  <button type="submit" class="btn btn-primary">ğŸ“ í•©ì¹˜ê¸°</button>
</form>

{% if merged_file_url %}
  <div class="mt-4">
    <p>âœ… í•©ì³ì§„ PDF íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”:</p>
    <a href="{{ merged_file_url }}" class="btn btn-success" download>ğŸ“¥ ë‹¤ìš´ë¡œë“œ</a>
  </div>
{% endif %}

<style>
  #file-list li {
    cursor: grab;
  }
</style>

<script>
let fileInput = document.getElementById('pdf-input');
let fileList = document.getElementById('file-list');
let form = document.getElementById('pdf-form');
let files = [];

fileInput.addEventListener('change', (e) => {
  files = Array.from(e.target.files);
  renderFileList();
});

function renderFileList() {
  fileList.innerHTML = '';
  files.forEach((file, index) => {
    const li = document.createElement('li');
    li.className = 'list-group-item';
    li.textContent = file.name;
    li.draggable = true;
    li.dataset.index = index;

    li.addEventListener('dragstart', (e) => {
      e.dataTransfer.setData('text/plain', index);
    });

    li.addEventListener('dragover', (e) => {
      e.preventDefault();
      li.style.background = '#e9ecef';
    });

    li.addEventListener('dragleave', () => {
      li.style.background = '';
    });

    li.addEventListener('drop', (e) => {
      e.preventDefault();
      let from = parseInt(e.dataTransfer.getData('text/plain'));
      let to = parseInt(li.dataset.index);
      [files[from], files[to]] = [files[to], files[from]];
      renderFileList();
    });

    fileList.appendChild(li);
  });
}

// í¼ ì œì¶œ ì‹œ ìˆœì„œ ìœ ì§€í•´ì„œ FormDataë¡œ ì „ì†¡
form.addEventListener('submit', (e) => {
  e.preventDefault();
  const formData = new FormData();
  files.forEach(f => formData.append('pdfs', f));

  const filename = document.getElementById('filename').value.trim();
  formData.append('filename', filename);

  fetch('/pdf', {
    method: 'POST',
    body: formData
  }).then(res => res.text()).then(html => {
    document.body.innerHTML = html;
  });
});
</script>

{% endblock %}
